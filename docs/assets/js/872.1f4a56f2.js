"use strict";(self.webpackChunkct_docs=self.webpackChunkct_docs||[]).push([[872],{872:(e,t,r)=>{r.d(t,{a:()=>oe,b:()=>ie,c:()=>le});var n=r(7508),s=r(8431),a=Object.keys({arabic:"ar",armenian:"am",bulgarian:"bg",danish:"dk",dutch:"nl",english:"en",finnish:"fi",french:"fr",german:"de",greek:"gr",hungarian:"hu",indian:"in",indonesian:"id",irish:"ie",italian:"it",lithuanian:"lt",nepali:"np",norwegian:"no",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"rs",slovenian:"ru",spanish:"es",swedish:"se",tamil:"ta",turkish:"tr",ukrainian:"uk",sanskrit:"sk"});Date.now().toString().slice(5);var o=BigInt(1e3),i=BigInt(1e6),l=BigInt(1e9),c=65535;function u(e,t){if(t.length<c)Array.prototype.push.apply(e,t);else{let r=t.length;for(let n=0;n<r;n+=c)Array.prototype.push.apply(e,t.slice(n,n+c))}}function h(e,...t){return e.replace(/%(?:(?<position>\d+)\$)?(?<width>-?\d*\.?\d*)(?<type>[dfs])/g,(function(...e){let r=e[e.length-1],{width:n,type:s,position:a}=r,o=a?t[Number.parseInt(a)-1]:t.shift(),i=""===n?0:Number.parseInt(n);switch(s){case"d":return o.toString().padStart(i,"0");case"f":{let e=o,[t,r]=n.split(".").map((e=>Number.parseFloat(e)));return"number"==typeof r&&r>=0&&(e=e.toFixed(r)),"number"==typeof t&&t>=0?e.toString().padStart(i,"0"):e.toString()}case"s":return i<0?o.toString().padEnd(-i," "):o.toString().padStart(i," ");default:return o}}))}function d(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}function f(){return typeof process<"u"&&process.release&&"node"===process.release.name}function p(){return BigInt(Math.floor(1e6*performance.now()))}function g(e){return"number"==typeof e&&(e=BigInt(e)),e<o?`${e}ns`:e<i?e/o+"\u03bcs":e<l?e/i+"ms":e/l+"s"}function m(){return d()?p():f()||typeof process<"u"&&"function"==typeof process?.hrtime?.bigint?process.hrtime.bigint():typeof performance<"u"?p():BigInt(0)}function S(e,t){return t[1]===e[1]?e[0]-t[0]:t[1]-e[1]}function y(e){if(0===e.length)return[];if(1===e.length)return e[0];for(let r=1;r<e.length;r++)if(e[r].length<e[0].length){let t=e[0];e[0]=e[r],e[r]=t}let t=new Map;for(let r of e[0])t.set(r,1);for(let r=1;r<e.length;r++){let n=0;for(let s of e[r]){let e=t.get(s);e===r&&(t.set(s,e+1),n++)}if(0===n)return[]}return e[0].filter((r=>{let n=t.get(r);return void 0!==n&&t.set(r,0),n===e.length}))}function I(e,t){let r={},n=t.length;for(let s=0;s<n;s++){let n=t[s],a=n.split("."),o=e,i=a.length;for(let e=0;e<i;e++)if(o=o[a[e]],"object"==typeof o){if(null!==o&&"lat"in o&&"lon"in o&&"number"==typeof o.lat&&"number"==typeof o.lon){o=r[n]=o;break}if(!Array.isArray(o)&&null!==o&&e===i-1){o=void 0;break}}else if((null===o||"object"!=typeof o)&&e<i-1){o=void 0;break}typeof o<"u"&&(r[n]=o)}return r}function _(e,t){return I(e,[t])[t]}function b(e,t){e.hits=e.hits.map((e=>({...e,document:{...e.document,...t.reduce(((e,t)=>{let r=t.split("."),n=r.pop(),s=e;for(let a of r)s[a]=s[a]??{},s=s[a];return s[n]=null,e}),e.document)}})))}function N(e){return Array.isArray(e)?e.some((e=>N(e))):"AsyncFunction"===e?.constructor?.name}(0,s.a)(u,"safeArrayPush"),(0,s.a)(h,"sprintf"),(0,s.a)(d,"isInsideWebWorker"),(0,s.a)(f,"isInsideNode"),(0,s.a)(p,"getNanosecondTimeViaPerformance"),(0,s.a)(g,"formatNanoseconds"),(0,s.a)(m,"getNanosecondsTime"),(0,s.a)(S,"sortTokenScorePredicate"),(0,s.a)(y,"intersect"),(0,s.a)(I,"getDocumentProperties"),(0,s.a)(_,"getNested"),(0,s.a)(b,"removeVectorsFromHits"),(0,s.a)(N,"isAsyncFunction");var E={NO_LANGUAGE_WITH_CUSTOM_TOKENIZER:"Do not pass the language option to create when using a custom tokenizer.",LANGUAGE_NOT_SUPPORTED:`Language "%s" is not supported.\nSupported languages are:\n - ${a.join("\n - ")}`,INVALID_STEMMER_FUNCTION_TYPE:"config.stemmer property must be a function.",MISSING_STEMMER:'As of version 1.0.0 @orama/orama does not ship non English stemmers by default. To solve this, please explicitly import and specify the "%s" stemmer from the package @orama/stemmers. See https://docs.orama.com/open-source/text-analysis/stemming for more information.',CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY:"Custom stop words array must only contain strings.",UNSUPPORTED_COMPONENT:'Unsupported component "%s".',COMPONENT_MUST_BE_FUNCTION:'The component "%s" must be a function.',COMPONENT_MUST_BE_FUNCTION_OR_ARRAY_FUNCTIONS:'The component "%s" must be a function or an array of functions.',INVALID_SCHEMA_TYPE:'Unsupported schema type "%s" at "%s". Expected "string", "boolean" or "number" or array of them.',DOCUMENT_ID_MUST_BE_STRING:'Document id must be of type "string". Got "%s" instead.',DOCUMENT_ALREADY_EXISTS:'A document with id "%s" already exists.',DOCUMENT_DOES_NOT_EXIST:'A document with id "%s" does not exists.',MISSING_DOCUMENT_PROPERTY:'Missing searchable property "%s".',INVALID_DOCUMENT_PROPERTY:'Invalid document property "%s": expected "%s", got "%s"',UNKNOWN_INDEX:'Invalid property name "%s". Expected a wildcard string ("*") or array containing one of the following properties: %s',INVALID_BOOST_VALUE:"Boost value must be a number greater than, or less than 0.",INVALID_FILTER_OPERATION:"You can only use one operation per filter, you requested %d.",SCHEMA_VALIDATION_FAILURE:'Cannot insert document due schema validation failure on "%s" property.',INVALID_SORT_SCHEMA_TYPE:'Unsupported sort schema type "%s" at "%s". Expected "string" or "number".',CANNOT_SORT_BY_ARRAY:'Cannot configure sort for "%s" because it is an array (%s).',UNABLE_TO_SORT_ON_UNKNOWN_FIELD:'Unable to sort on unknown field "%s". Allowed fields: %s',SORT_DISABLED:"Sort is disabled. Please read the documentation at https://docs.oramasearch for more information.",UNKNOWN_GROUP_BY_PROPERTY:'Unknown groupBy property "%s".',INVALID_GROUP_BY_PROPERTY:'Invalid groupBy property "%s". Allowed types: "%s", but given "%s".',UNKNOWN_FILTER_PROPERTY:'Unknown filter property "%s".',INVALID_VECTOR_SIZE:'Vector size must be a number greater than 0. Got "%s" instead.',INVALID_VECTOR_VALUE:'Vector value must be a number greater than 0. Got "%s" instead.',INVALID_INPUT_VECTOR:'Property "%s" was declared as a %s-dimensional vector, but got a %s-dimensional vector instead.\nInput vectors must be of the size declared in the schema, as calculating similarity between vectors of different sizes can lead to unexpected results.',WRONG_SEARCH_PROPERTY_TYPE:'Property "%s" is not searchable. Only "string" properties are searchable.',FACET_NOT_SUPPORTED:'Facet doens\'t support the type "%s".',INVALID_DISTANCE_SUFFIX:'Invalid distance suffix "%s". Valid suffixes are: cm, m, km, mi, yd, ft.',INVALID_SEARCH_MODE:'Invalid search mode "%s". Valid modes are: "fulltext", "vector", "hybrid".',MISSING_VECTOR_AND_SECURE_PROXY:"No vector was provided and no secure proxy was configured. Please provide a vector or configure an Orama Secure Proxy to perform hybrid search.",MISSING_TERM:'"term" is a required parameter when performing hybrid search. Please provide a search term.',INVALID_VECTOR_INPUT:'Invalid "vector" property. Expected an object with "value" and "property" properties, but got "%s" instead.',PLUGIN_CRASHED:"A plugin crashed during initialization. Please check the error message for more information:",PLUGIN_SECURE_PROXY_NOT_FOUND:"Could not find '@orama/secure-proxy-plugin' installed in your Orama instance.\nPlease install it before proceeding with creating an answer session.\nRead more at https://docs.orama.com/open-source/plugins/plugin-secure-proxy#plugin-secure-proxy\n",PLUGIN_SECURE_PROXY_MISSING_CHAT_MODEL:"Could not find a chat model defined in the secure proxy plugin configuration.\nPlease provide a chat model before proceeding with creating an answer session.\nRead more at https://docs.orama.com/open-source/plugins/plugin-secure-proxy#plugin-secure-proxy\n",ANSWER_SESSION_LAST_MESSAGE_IS_NOT_ASSISTANT:"The last message in the session is not an assistant message. Cannot regenerate non-assistant messages.",PLUGIN_COMPONENT_CONFLICT:'The component "%s" is already defined. The plugin "%s" is trying to redefine it.'};function O(e,...t){let r=new Error(h(E[e]??`Unsupported Orama Error code: ${e}`,...t));return r.code=e,"captureStackTrace"in Error.prototype&&Error.captureStackTrace(r),r}function T(e,t){if("string"==typeof t){let r=e.idToInternalId.get(t);if(r)return r;let n=e.idToInternalId.size+1;return e.idToInternalId.set(t,n),e.internalIdToId.push(t),n}return t>e.internalIdToId.length?T(e,t.toString()):t}function w(e,t){if(e.internalIdToId.length<t)throw new Error(`Invalid internalId ${t}`);return e.internalIdToId[t-1]}function A(e,t,r,n,s){if(e.some(N))return(async()=>{for(let a of e)await a(t,r,n,s)})();for(let a of e)a(t,r,n,s)}function C(e,t,r,n){if(e.some(N))return(async()=>{for(let s of e)await s(t,r,n)})();for(let s of e)s(t,r,n)}(0,s.a)(O,"createError"),(0,s.a)(T,"getInternalDocumentId"),(0,s.a)(w,"getDocumentIdFromInternalId"),(0,s.a)(A,"runAfterSearch"),(0,s.a)(C,"runBeforeSearch");function v(e){return e.documentsStore.count(e.data.docs)}(0,s.a)(v,"count");var P="fulltext";function R(e,t){return e[1]-t[1]}function D(e,t){return t[1]-e[1]}function x(e="desc"){return"asc"===e.toLowerCase()?R:D}function M(e,t,r){let n={},s=t.map((([e])=>e)),a=e.documentsStore.getMultiple(e.data.docs,s),o=Object.keys(r),i=e.index.getSearchablePropertiesWithTypes(e.data.index);for(let c of o){let e;if("number"===i[c]){let{ranges:t}=r[c],n=t.length,s=Array.from({length:n});for(let e=0;e<n;e++){let r=t[e];s[e]=[`${r.from}-${r.to}`,0]}e=Object.fromEntries(s)}n[c]={count:0,values:e??{}}}let l=a.length;for(let c=0;c<l;c++){let e=a[c];for(let t of o){let s=t.includes(".")?_(e,t):e[t],a=i[t],o=n[t].values;switch(a){case"number":U(r[t].ranges,o)(s);break;case"number[]":{let e=new Set,n=U(r[t].ranges,o,e);for(let t of s)n(t);break}case"boolean":case"enum":case"string":k(o,a)(s);break;case"boolean[]":case"enum[]":case"string[]":{let e=k(o,"boolean[]"===a?"boolean":"string",new Set);for(let t of s)e(t);break}default:throw O("FACET_NOT_SUPPORTED",a)}}}for(let c of o){let e=n[c];if(e.count=Object.keys(e.values).length,"string"===i[c]){let t=r[c],n=x(t.sort);e.values=Object.fromEntries(Object.entries(e.values).sort(n).slice(t.offset??0,t.limit??10))}}return n}function U(e,t,r){return n=>{for(let s of e){let e=`${s.from}-${s.to}`;r?.has(e)||n>=s.from&&n<=s.to&&(void 0===t[e]?t[e]=1:(t[e]++,r?.add(e)))}}}function k(e,t,r){let n="boolean"===t?"false":"";return t=>{let s=t?.toString()??n;r?.has(s)||(e[s]=(e[s]??0)+1,r?.add(s))}}(0,s.a)(R,"sortAsc"),(0,s.a)(D,"sortDesc"),(0,s.a)(x,"sortingPredicateBuilder"),(0,s.a)(M,"getFacets"),(0,s.a)(U,"calculateNumberFacetBuilder"),(0,s.a)(k,"calculateBooleanStringOrEnumFacetBuilder");var L={reducer:(0,s.a)(((e,t,r,n)=>(t[n]=r,t)),"reducer"),getInitialValue:(0,s.a)((e=>Array.from({length:e})),"getInitialValue")},V=["string","number","boolean"];function B(e,t,r){let n=r.properties,s=n.length,a=e.index.getSearchablePropertiesWithTypes(e.data.index);for(let S=0;S<s;S++){let e=n[S];if(typeof a[e]>"u")throw O("UNKNOWN_GROUP_BY_PROPERTY",e);if(!V.includes(a[e]))throw O("INVALID_GROUP_BY_PROPERTY",e,V.join(", "),a[e])}let o=t.map((([t])=>w(e.internalDocumentIDStore,t))),i=e.documentsStore.getMultiple(e.data.docs,o),l=i.length,c=r.maxResult||Number.MAX_SAFE_INTEGER,u=[],h={};for(let S=0;S<s;S++){let e=n[S],t={property:e,perValue:{}},r=new Set;for(let n=0;n<l;n++){let s=_(i[n],e);if(typeof s>"u")continue;let a="boolean"!=typeof s?s:""+s,o=t.perValue[a]??{indexes:[],count:0};o.count>=c||(o.indexes.push(n),o.count++,t.perValue[a]=o,r.add(s))}u.push(Array.from(r)),h[e]=t}let d=G(u),f=d.length,p=[];for(let S=0;S<f;S++){let e=d[S],t=e.length,r={values:[],indexes:[]},s=[];for(let a=0;a<t;a++){let t=e[a],o=n[a];s.push(h[o].perValue["boolean"!=typeof t?t:""+t].indexes),r.values.push(t)}r.indexes=y(s).sort(((e,t)=>e-t)),0!==r.indexes.length&&p.push(r)}let g=p.length,m=Array.from({length:g});for(let S=0;S<g;S++){let e=p[S],n=r.reduce||L,s=e.indexes.map((e=>({id:o[e],score:t[e][1],document:i[e]}))),a=n.reducer.bind(null,e.values),l=n.getInitialValue(e.indexes.length),c=s.reduce(a,l);m[S]={values:e.values,result:c}}return m}function G(e,t=0){if(t+1===e.length)return e[t].map((e=>[e]));let r=e[t],n=G(e,t+1),s=[];for(let a of r)for(let e of n){let t=[a];u(t,e),s.push(t)}return s}function F(e,t,r){let n,s,{term:a,properties:o}=t,i=e.data.index,l=e.caches.propertiesToSearch;if(!l){let t=e.index.getSearchablePropertiesWithTypes(i);l=e.index.getSearchableProperties(i),l=l.filter((e=>t[e].startsWith("string"))),e.caches.propertiesToSearch=l}if(o&&"*"!==o){for(let e of o)if(!l.includes(e))throw O("UNKNOWN_INDEX",e,l.join(", "));l=l.filter((e=>o.includes(e)))}if(Object.keys(t.where??{}).length>0&&(n=e.index.searchByWhereClause(i,e.tokenizer,t.where,r)),a||o){let o=v(e);s=e.index.search(i,a||"",e.tokenizer,r,l,t.exact||!1,t.tolerance||0,t.boost||{},W(t.relevance),o,n)}else s=(n?Array.from(n):Object.keys(e.documentsStore.getAll(e.data.docs))).map((e=>[+e,0]));return s}function Y(e,t,r){let n=m();function a(){let s,a=Object.keys(e.data.index.vectorIndexes),o=t.facets&&Object.keys(t.facets).length>0,{limit:i=10,offset:l=0,distinctOn:c,includeVectors:u=!1}=t,h=!0===t.preflight,d=F(e,t,r);if(t.sortBy)if("function"==typeof t.sortBy){let r=d.map((([e])=>e)),n=e.documentsStore.getMultiple(e.data.docs,r).map(((e,t)=>[d[t][0],d[t][1],e]));n.sort(t.sortBy),d=n.map((([e,t])=>[e,t]))}else d=e.sorter.sortBy(e.data.sorting,d,t.sortBy).map((([t,r])=>[T(e.internalDocumentIDStore,t),r]));else d=d.sort(S);h||(s=c?re(e,d,l,i,c):ne(e,d,l,i));let f={elapsed:{formatted:"",raw:0},hits:[],count:d.length};if(typeof s<"u"&&(f.hits=s.filter(Boolean),u||b(f,a)),o){let r=M(e,d,t.facets);f.facets=r}return t.groupBy&&(f.groups=B(e,d,t.groupBy)),f.elapsed=e.formatElapsedTime(m()-n),f}async function o(){e.beforeSearch&&await C(e.beforeSearch,e,t,r);let n=a();return e.afterSearch&&await A(e.afterSearch,e,t,r,n),n}return(0,s.a)(a,"performSearchLogic"),(0,s.a)(o,"executeSearchAsync"),e.beforeSearch?.length||e.afterSearch?.length?o():a()}(0,s.a)(B,"getGroups"),(0,s.a)(G,"calculateCombination"),(0,s.a)(F,"innerFullTextSearch"),(0,s.a)(Y,"fullTextSearch");var j={k:1.2,b:.75,d:.5};function W(e){let t=e??{};return t.k=t.k??j.k,t.b=t.b??j.b,t.d=t.d??j.d,t}function z(e,t,r){let n=t.vector;if(n&&(!("value"in n)||!("property"in n)))throw O("INVALID_VECTOR_INPUT",Object.keys(n).join(", "));let s=e.data.index.vectorIndexes[n.property],a=s.node.size;if(n?.value.length!==a)throw void 0===n?.property||void 0===n?.value.length?O("INVALID_INPUT_VECTOR","undefined",a,"undefined"):O("INVALID_INPUT_VECTOR",n.property,a,n.value.length);let o,i=e.data.index;return Object.keys(t.where??{}).length>0&&(o=e.index.searchByWhereClause(i,e.tokenizer,t.where,r)),s.node.find(n.value,t.similarity??.8,o)}function H(e,t,r="english"){let n=m();function a(){let s=z(e,t,r).sort(S),a=[];t.facets&&Object.keys(t.facets).length>0&&(a=M(e,s,t.facets));let o=t.vector.property,i=t.includeVectors??!1,l=t.limit??10,c=t.offset??0,u=Array.from({length:l});for(let t=0;t<l;t++){let r=s[t+c];if(!r)break;let n=e.data.docs.docs[r[0]];if(n){i||(n[o]=null);let s={id:w(e.internalDocumentIDStore,r[0]),score:r[1],document:n};u[t]=s}}let h=[];t.groupBy&&(h=B(e,s,t.groupBy));let d=m()-n;return{count:s.length,hits:u.filter(Boolean),elapsed:{raw:Number(d),formatted:g(d)},...a?{facets:a}:{},...h?{groups:h}:{}}}async function o(){e.beforeSearch&&await C(e.beforeSearch,e,t,r);let n=a();return e.afterSearch&&await A(e.afterSearch,e,t,r,n),n}return(0,s.a)(a,"performSearchLogic"),(0,s.a)(o,"executeSearchAsync"),e.beforeSearch?.length||e.afterSearch?.length?o():a()}function X(e,t,r){let n=K(F(e,t,r)),s=z(e,t,r),a=t.hybridWeights;return J(n,s,t.term??"",a)}function q(e,t,r){let n=m();function a(){let s,a,o=X(e,t,r);t.facets&&Object.keys(t.facets).length>0&&(s=M(e,o,t.facets)),t.groupBy&&(a=B(e,o,t.groupBy));let i=t.offset??0,l=t.limit??10,c=ne(e,o,i,l).filter(Boolean),u=m(),h={count:o.length,elapsed:{raw:Number(u-n),formatted:g(u-n)},hits:c,...s?{facets:s}:{},...a?{groups:a}:{}};if(!t.includeVectors){b(h,Object.keys(e.data.index.vectorIndexes))}return h}async function o(){e.beforeSearch&&await C(e.beforeSearch,e,t,r);let n=a();return e.afterSearch&&await A(e.afterSearch,e,t,r,n),n}return(0,s.a)(a,"performSearchLogic"),(0,s.a)(o,"executeSearchAsync"),e.beforeSearch?.length||e.afterSearch?.length?o():a()}function $(e){return e[1]}function K(e){let t=Math.max.apply(Math,e.map($));return e.map((([e,r])=>[e,r/t]))}function Q(e,t){return e/t}function Z(e,t){return(r,n)=>r*e+n*t}function J(e,t,r,n){let s=Math.max.apply(Math,e.map($)),a=Math.max.apply(Math,t.map($)),o=n&&n.text&&n.vector,{text:i,vector:l}=o?n:{text:.5,vector:.5},c=new Map,u=e.length,h=Z(i,l);for(let f=0;f<u;f++){let[t,r]=e[f],n=h(Q(r,s),0);c.set(t,n)}let d=t.length;for(let f=0;f<d;f++){let[e,r]=t[f],n=Q(r,a),s=c.get(e)??0;c.set(e,s+h(0,n))}return[...c].sort(((e,t)=>t[1]-e[1]))}function ee(e){return{text:.5,vector:.5}}function te(e,t,r){let n=t.mode??P;if(n===P)return Y(e,t,r);if("vector"===n)return H(e,t);if("hybrid"===n)return q(e,t);throw O("INVALID_SEARCH_MODE",n)}function re(e,t,r,n,s){let a=e.data.docs,o=new Map,i=[],l=new Set,c=t.length,u=0;for(let h=0;h<c;h++){let c=t[h];if(typeof c>"u")continue;let[d,f]=c;if(l.has(d))continue;let p=e.documentsStore.get(a,d),g=_(p,s);if(!(typeof g>"u"||o.has(g))&&(o.set(g,!0),u++,!(u<=r)&&(i.push({id:w(e.internalDocumentIDStore,d),score:f,document:p}),l.add(d),u>=r+n)))break}return i}function ne(e,t,r,n){let s=e.data.docs,a=Array.from({length:n}),o=new Set;for(let i=r;i<n+r;i++){let r=t[i];if(typeof r>"u")break;let[n,l]=r;if(!o.has(n)){let t=e.documentsStore.get(s,n);a[i]={id:w(e.internalDocumentIDStore,n),score:l,document:t},o.add(n)}}return a}(0,s.a)(W,"applyDefault"),(0,s.a)(z,"innerVectorSearch"),(0,s.a)(H,"searchVector"),(0,s.a)(X,"innerHybridSearch"),(0,s.a)(q,"hybridSearch"),(0,s.a)($,"extractScore"),(0,s.a)(K,"minMaxScoreNormalization"),(0,s.a)(Q,"normalizeScore"),(0,s.a)(Z,"hybridScoreBuilder"),(0,s.a)(J,"mergeAndRankResults"),(0,s.a)(ee,"getQueryWeights"),(0,s.a)(te,"search"),(0,s.a)(re,"fetchDocumentsWithDistinct"),(0,s.a)(ne,"fetchDocuments");var se=class{static{(0,s.a)(this,"AnswerSession")}db;proxy=null;config;abortController=null;lastInteractionParams=null;chatModel=null;conversationID;messages=[];events;initPromise;state=[];constructor(e,t){this.db=e,this.config=t,this.init(),this.messages=t.initialMessages||[],this.events=t.events||{},this.conversationID=t.conversationID||this.generateRandomID()}async ask(e){await this.initPromise;let t="";for await(let r of await this.askStream(e))t+=r;return t}async askStream(e){return await this.initPromise,this.fetchAnswer(e)}abortAnswer(){this.abortController?.abort(),this.state[this.state.length-1].aborted=!0,this.triggerStateChange()}getMessages(){return this.messages}clearSession(){this.messages=[],this.state=[]}regenerateLast({stream:e=!0}){if(0===this.state.length||0===this.messages.length)throw new Error("No messages to regenerate");if("assistant"!==this.messages.at(-1)?.role)throw O("ANSWER_SESSION_LAST_MESSAGE_IS_NOT_ASSISTANT");return this.messages.pop(),this.state.pop(),e?this.askStream(this.lastInteractionParams):this.ask(this.lastInteractionParams)}async*fetchAnswer(e){if(!this.chatModel)throw O("PLUGIN_SECURE_PROXY_MISSING_CHAT_MODEL");this.abortController=new AbortController,this.lastInteractionParams=e;let t=this.generateRandomID();this.messages.push({role:"user",content:e.term??""}),this.state.push({interactionId:t,aborted:!1,loading:!0,query:e.term??"",response:"",sources:null,translatedQuery:null,error:!1,errorMessage:null});let r=this.state.length-1;this.addEmptyAssistantMessage(),this.triggerStateChange();try{let t=await te(this.db,e);this.state[r].sources=t,this.triggerStateChange();for await(let e of this.proxy.chatStream({model:this.chatModel,messages:this.messages}))yield e,this.state[r].response+=e,this.messages.findLast((e=>"assistant"===e.role)).content+=e,this.triggerStateChange()}catch(n){"AbortError"===n.name?this.state[r].aborted=!0:(this.state[r].error=!0,this.state[r].errorMessage=n.toString()),this.triggerStateChange()}return this.state[r].loading=!1,this.triggerStateChange(),this.state[r].response}generateRandomID(e=24){return Array.from({length:e},(()=>Math.floor(36*Math.random()).toString(36))).join("")}triggerStateChange(){this.events.onStateChange&&this.events.onStateChange(this.state)}async init(){let e=this;async function t(){return await e.db.plugins.find((e=>"orama-secure-proxy"===e.name))}(0,s.a)(t,"getPlugin");let r=await t();if(!r)throw O("PLUGIN_SECURE_PROXY_NOT_FOUND");let n=r.extra;if(this.proxy=n.proxy,this.config.systemPrompt&&this.messages.push({role:"system",content:this.config.systemPrompt}),!n?.pluginParams?.chat?.model)throw O("PLUGIN_SECURE_PROXY_MISSING_CHAT_MODEL");this.chatModel=n.pluginParams.chat.model}addEmptyAssistantMessage(){this.messages.push({role:"assistant",content:""})}};function ae(e){return e&&"object"==typeof e&&"api_key"in e&&"endpoint"in e}(0,s.a)(ae,"isOramaClient");var oe=class{static{(0,s.a)(this,"Switch")}invalidClientError="Invalid client. Expected either an OramaClient or an Orama OSS database.";client;clientType;isCloud=!1;isOSS=!1;constructor(e){if(this.client=e,ae(e))this.clientType="cloud",this.isCloud=!0;else{if("object"!=typeof e||!("id"in e)||!("tokenizer"in e))throw new Error(this.invalidClientError);this.clientType="oss",this.isOSS=!0}}async search(e,t){return this.isCloud?this.client.search(e,t):te(this.client,e)}createAnswerSession(e){if(this.isCloud){let t=e;return this.client.createAnswerSession(t)}if(this.isOSS){let t=e;return new se(this.client,{conversationID:t.conversationID,initialMessages:t.initialMessages,events:t.events,userContext:t.userContext,systemPrompt:t.systemPrompt})}throw new Error(this.invalidClientError)}},ie=class extends Error{static{(0,s.a)(this,"OramaClientNotInitializedError")}constructor(){super("Orama Client is not initialized")}},le=class{static{(0,s.a)(this,"ChatService")}constructor(e,t){this.sendQuestion=(e,t,r)=>{if(!this.oramaClient)throw new ie;let a={term:e,related:{howMany:3,format:"question"}};if(!this.answerSession){let e=this.chatStore.state.interactions;this.answerSession=this.oramaClient.createAnswerSession({events:{onStateChange:(0,s.a)((t=>{let s=t.filter((e=>!!e.query));this.chatStore.state.interactions=[...e||[],...s.map(((e,s)=>{var o,i,l;let c=t.length-1===s,u=n.a.loading,h=[];return e.aborted?u=n.a.aborted:e.loading&&e.sources?u=n.a.rendering:e.loading&&e.response?u=n.a.streaming:!e.loading&&e.response&&(u=n.a.done),e.sources&&(h=Array.isArray(e.sources)?null===(o=e.sources)||void 0===o?void 0:o.map((e=>e.document)):null===(i=e.sources.hits)||void 0===i?void 0:i.map((e=>e.document))),c&&u===n.a.done&&(null===(l=r?.onAnswerGeneratedCallback)||void 0===l||l.call(r,{askParams:a,query:e.query,sources:e.sources,answer:e.response,segment:e.segment,trigger:e.trigger})),{query:e.query,interactionId:e.interactionId,response:e.response,relatedQueries:e.relatedQueries,status:u,latest:c,sources:h}}))]}),"onStateChange")}}),"cloud"===this.oramaClient.clientType&&t&&this.answerSession.setSystemPromptConfiguration({systemPrompts:t})}return this.answerSession.ask(a).catch((e=>{this.chatStore.state.interactions=this.chatStore.state.interactions.map(((e,t)=>t===this.chatStore.state.interactions.length-1?Object.assign(Object.assign({},e),{status:n.a.error}):e)),console.error(e)}))},this.abortAnswer=()=>{if(!this.answerSession)throw new ie;this.answerSession.abortAnswer()},this.regenerateLatest=async()=>{if(!this.answerSession)throw new ie;this.answerSession.regenerateLast({stream:!1})},this.resetChat=async()=>{if(!this.answerSession)throw new ie;this.chatStore.state.interactions.length<1||(["loading","rendering","streaming"].includes(this.chatStore.state.interactions[this.chatStore.state.interactions.length-1].status)&&this.answerSession.abortAnswer(),this.answerSession.clearSession(),this.chatStore.state.interactions=[])},this.oramaClient=new oe(e),this.chatStore=t}}},7508:(e,t,r)=>{var n,s;r.d(t,{a:()=>n}),(s=n||(n={})).idle="idle",s.loading="loading",s.rendering="rendering",s.streaming="streaming",s.error="error",s.aborted="aborted",s.done="done"}}]);